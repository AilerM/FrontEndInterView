### 批量PDF生成过程

#### 需求场景
>将一个可视化在线报告的网页导出成PDF，并存储到服务器，生成用户可以下载的链接,每月定日跑 大概千分报告

#### 进化历史
- 1: 问题：需要将这模块适配成PDF大小，包含分页和PDF头和PDF尾
  > 解决：由于需要导出PDF页面对用户不可见，则若在重新写模块太过于耗费资源；故在开发此次在线报告时候，模块细致且都为数据组成也考虑支持PDF情况；通过对原始数据的拆分和重组，以及批量将HTML定义多个ID,一次读取对应ID的Canvas，并依次转化为Base64，依次addPage到PDF中，异步过多避免毁掉地狱，使用async await，

- 2: 问题：Html2canvas JsPdf 只支持单一页面的，无法批量
  > 解决：由于前端只支持实时性 用户点击按钮出发下载PDF程序，无法批量生成，故舍弃，使用爬虫式 基于Node平台用Egg构建，需要结合Puppeteer工具进行开发

- 3: 问题：Node的Puppeteer工具开发，与项目结合还是独立成一个工具类
  > 解决：由于多个项目存着类似导出PDF需求，故整做成一个工具类，为每个项目制定不同模块与接口

- 4：问题：Puppeteer工具导出分页PDF,不存在此API，其他插件也未找到很稳定的，分页偶尔不是很灵活
  > 解决：发现Puppeteer导出PDF，其实是基于Chrome自带导出PDF方式，找到Chrome打印工具，与网页中绘制的HTML宽高比例进行本地打印测试，找到最匹配chrome纸张尺寸的设置；很巧合Letter即完美支持且稳定，（注意严格控制HTML中宽高比）另外可以用css属性page-break-before、 page-break-after控制分页

- 5: 优化：多个平台使用
  > 方式：将JS变为TS，并将Egg方法与各个环境进行区分，增加测试 本地 线上环境

- 6: 问题：后端PHP调用Node程序时候，发现报告只取第一次的参数，导致多分报告内容不变
  > 解决：
    - 通过查看Egg日志，后端参数传递无问题；
    - 检查前端平台参数格式与Egg处理是否一致，结果显示一致；
    - 怀疑Node缓存，重新上传文件，重启服务，依然存着该问题
    - 怀疑是否将参数变量定义为const，分析Egg程序逻辑排除
    - 最后：由于其他项目逻辑与该项目逻辑不同，导致每次取都去数组第一位，无法正常取值；

- 7: 问题：部署线上发现无法请求到网页数据
  > 解决：线上为https Puppeteer需要进行配置ignoreHTTPSErrors ； true，进行忽略https证书过期错误；

- 8：优化：报告一份平均1.5M，速度15秒左右过慢
  > 解决：由于当前是每生成一份报告Puppeteer 启动浏览器，最后监听到无请求状态 waitUntil: 'networkidle0'，则转化为PDF, 最后在关闭；每一份都如此循环，反复关闭打开浏览器；故在网页中定义一个方法，传入不同参数生成对应报告内容，通过Egg调用该网页中的方法；优化速度为减少了2倍 7秒左右

- 9: 问题：无法使用networkidle0 如何监听数据请求结束并渲染完成
  > 解决：网页中的方法，在未请求完数据前一直处于挂起状态无法回，保证了数据获取完成；
  由于Echarts图有动画且存着一定时间，在Egg中，监听网页方法返回之后，未来保证图形动画结束，需要100sm延迟，部分图100ms不够，动画依然未展示全，目前准备加延迟时间，希望找到API可以移除Echarts动画时间

- 10: 问题：后端请求Node一直返回204
  >解决：由于产品只能供内网访问，两台服务器之间需要互相配置互相访问，后端人员在host配置了一下，

- 11: 问题：下载PDF变成方块
    >解决：服务器系统字体不够   

- 12: 若并发请求服务过多，容易卡死，返回数据内容未空
    >未解决：重新启动服务

- 13: 终极问题：由于node工具 php 前端 对应三方，定位问题往往不清晰，需要三方一起来看，最危险的想法，他觉得你这块问题，你觉得他这块问题不沟通，导致问题迟迟不解决；

